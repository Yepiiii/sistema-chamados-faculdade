<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:SistemaChamados.Mobile.ViewModels"
             x:Class="SistemaChamados.Mobile.Views.ChamadoDetailPage"
             Title="Detalhes">
  <ContentPage.Resources>
    <LinearGradientBrush x:Key="DetailHeaderGradient" StartPoint="0,0" EndPoint="1,1">
      <GradientStop Color="#2A5FDF" Offset="0" />
      <GradientStop Color="#3FA5F5" Offset="1" />
    </LinearGradientBrush>
  </ContentPage.Resources>

  <ScrollView>
    <VerticalStackLayout Padding="24" Spacing="24">
      <Border Background="{StaticResource DetailHeaderGradient}" StrokeShape="RoundRectangle 28" StrokeThickness="0" Padding="24">
        <VerticalStackLayout Spacing="6">
          <Label Text="Detalhes do chamado"
                 FontSize="22"
                 FontAttributes="Bold"
                 TextColor="{DynamicResource White}" />
          <Label Text="{Binding Chamado.Titulo}"
                 FontSize="28"
                 FontAttributes="Bold"
                 TextColor="{DynamicResource White}" />
        </VerticalStackLayout>
      </Border>

      <Frame Padding="24" CornerRadius="20" BackgroundColor="{DynamicResource White}" BorderColor="{DynamicResource Gray200}">
        <VerticalStackLayout Spacing="20">
          <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto,Auto" ColumnSpacing="12" RowSpacing="12">
            <Border Grid.Row="0" Grid.Column="0" BackgroundColor="{DynamicResource Secondary}" StrokeThickness="0" StrokeShape="RoundRectangle 12" Padding="12,6">
              <Label Text="{Binding Chamado.Status.Nome}" TextColor="{DynamicResource PrimaryDarkText}" FontAttributes="Bold" />
            </Border>
            <Border Grid.Row="0" Grid.Column="1" Stroke="{DynamicResource Primary}" StrokeThickness="1" StrokeShape="RoundRectangle 12" Padding="12,6">
              <Label Text="{Binding Chamado.Prioridade.Nome}" TextColor="{DynamicResource Primary}" FontAttributes="Bold" />
            </Border>

            <!-- Data de Abertura -->
            <HorizontalStackLayout Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" Spacing="8">
              <Label Text="ðŸ“…" FontSize="16" VerticalOptions="Center" />
              <VerticalStackLayout Spacing="2">
                <Label Text="Abertura" 
                       FontSize="12" 
                       FontAttributes="Bold"
                       TextColor="{DynamicResource Gray600}" />
                <Label Text="{Binding Chamado.DataAbertura, Converter={StaticResource UtcToLocalConverter}, StringFormat='{0:dd/MM/yyyy HH:mm}'}"
                       FontSize="14"
                       TextColor="{DynamicResource Gray700}" />
              </VerticalStackLayout>
            </HorizontalStackLayout>

            <!-- Data de Encerramento -->
            <HorizontalStackLayout Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2" Spacing="8"
                                    IsVisible="{Binding HasFechamento}">
              <Label Text="âœ…" FontSize="16" VerticalOptions="Center" />
              <VerticalStackLayout Spacing="2">
                <Label Text="Encerramento" 
                       FontSize="12" 
                       FontAttributes="Bold"
                       TextColor="{DynamicResource Success}" />
                <Label Text="{Binding Chamado.DataFechamento, Converter={StaticResource UtcToLocalConverter}, StringFormat='{0:dd/MM/yyyy HH:mm}'}"
                       FontSize="14"
                       TextColor="{DynamicResource Gray700}" />
              </VerticalStackLayout>
            </HorizontalStackLayout>
          </Grid>

          <VerticalStackLayout Spacing="4"
                                IsVisible="{Binding Chamado.HasSolicitante}">
            <Label Text="Solicitante"
                   FontAttributes="Bold"
                   FontSize="16"
                   TextColor="{DynamicResource PrimaryDarkText}" />
            <Label Text="{Binding Chamado.SolicitanteDisplay}"
                   TextColor="{DynamicResource Gray600}" />
          </VerticalStackLayout>

          <VerticalStackLayout Spacing="8">
            <Label Text="DescriÃ§Ã£o"
                   FontAttributes="Bold"
                   FontSize="16"
                   TextColor="{DynamicResource PrimaryDarkText}" />
            <Label Text="{Binding Chamado.Descricao}"
                   TextColor="{DynamicResource Gray600}" />
          </VerticalStackLayout>
        </VerticalStackLayout>
      </Frame>

      <!-- Timeline de HistÃ³rico -->
      <Frame BackgroundColor="{DynamicResource White}"
             Padding="16"
             CornerRadius="12"
             HasShadow="True"
             Margin="0,16,0,0"
             IsVisible="{Binding Chamado.HasHistorico}">
        <VerticalStackLayout Spacing="8">
          <!-- CabeÃ§alho da seÃ§Ã£o -->
          <Label Text="ðŸ“œ HistÃ³rico de AtualizaÃ§Ãµes"
                 FontSize="16"
                 FontAttributes="Bold"
                 TextColor="{DynamicResource PrimaryDarkText}"
                 Margin="0,0,0,8" />

          <!-- CollectionView com Timeline -->
          <CollectionView ItemsSource="{Binding Chamado.Historico}"
                          SelectionMode="None">
            <CollectionView.ItemTemplate>
              <DataTemplate>
                <Grid Padding="0,0,0,16"
                      ColumnDefinitions="40,*"
                      RowDefinitions="Auto,Auto,Auto,Auto">

                  <!-- Linha vertical conectora -->
                  <BoxView Grid.Column="0"
                           Grid.Row="0"
                           Grid.RowSpan="4"
                           WidthRequest="2"
                           BackgroundColor="#E5E7EB"
                           HorizontalOptions="Center"
                           VerticalOptions="Fill"
                           Margin="0,24,0,0" />

                  <!-- Ãcone do evento (cÃ­rculo colorido com emoji) -->
                  <Frame Grid.Column="0"
                         Grid.Row="0"
                         WidthRequest="32"
                         HeightRequest="32"
                         CornerRadius="16"
                         Padding="0"
                         HasShadow="False"
                         BorderColor="{Binding CorEvento}"
                         BackgroundColor="{DynamicResource White}"
                         HorizontalOptions="Center"
                         VerticalOptions="Start">
                    <Label Text="{Binding IconeEvento}"
                           FontSize="16"
                           HorizontalOptions="Center"
                           VerticalOptions="Center" />
                  </Frame>

                  <!-- Card com conteÃºdo do evento -->
                  <Frame Grid.Column="1"
                         Grid.Row="0"
                         Padding="12"
                         CornerRadius="8"
                         BackgroundColor="#F9FAFB"
                         HasShadow="False"
                         BorderColor="#E5E7EB"
                         Margin="8,0,0,0">
                    <VerticalStackLayout Spacing="4">
                      <!-- Data e hora -->
                      <Label Text="{Binding DataHoraFormatada}"
                             FontSize="12"
                             TextColor="{DynamicResource Gray600}"
                             FontAttributes="Bold" />

                      <!-- DescriÃ§Ã£o completa (com mudanÃ§as de valor) -->
                      <Label Text="{Binding DescricaoCompleta}"
                             FontSize="14"
                             TextColor="{DynamicResource Gray700}"
                             LineBreakMode="WordWrap" />

                      <!-- UsuÃ¡rio responsÃ¡vel -->
                      <Label Text="{Binding Usuario, StringFormat='por {0}'}"
                             FontSize="12"
                             TextColor="{DynamicResource Gray600}"
                             IsVisible="{Binding Usuario, Converter={StaticResource IsNotNullConverter}}"
                             Margin="0,2,0,0" />
                    </VerticalStackLayout>
                  </Frame>
                </Grid>
              </DataTemplate>
            </CollectionView.ItemTemplate>

            <!-- EmptyView quando nÃ£o hÃ¡ histÃ³rico -->
            <CollectionView.EmptyView>
              <VerticalStackLayout Padding="20"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center">
                <Label Text="ðŸ“­"
                       FontSize="48"
                       HorizontalOptions="Center" />
                <Label Text="Nenhum histÃ³rico registrado"
                       FontSize="14"
                       TextColor="{DynamicResource Gray600}"
                       HorizontalOptions="Center"
                       Margin="0,8,0,0" />
              </VerticalStackLayout>
            </CollectionView.EmptyView>
          </CollectionView>
        </VerticalStackLayout>
      </Frame>

      <!-- Thread de ComentÃ¡rios -->
      <Frame BackgroundColor="{DynamicResource White}"
             Padding="16"
             CornerRadius="12"
             HasShadow="True"
             Margin="0,16,0,0">
        <VerticalStackLayout Spacing="12">
          <!-- CabeÃ§alho da seÃ§Ã£o -->
          <Label Text="ðŸ’¬ ComentÃ¡rios"
                 FontSize="16"
                 FontAttributes="Bold"
                 TextColor="{DynamicResource PrimaryDarkText}"
                 Margin="0,0,0,4" />

          <!-- Lista de ComentÃ¡rios -->
          <CollectionView ItemsSource="{Binding Comentarios}"
                          SelectionMode="None"
                          MaximumHeightRequest="400">
            <CollectionView.ItemTemplate>
              <DataTemplate>
                <Grid Padding="0,8"
                      ColumnDefinitions="40,*"
                      RowDefinitions="Auto,Auto">

                  <!-- Avatar do usuÃ¡rio -->
                  <Frame Grid.Column="0"
                         Grid.Row="0"
                         WidthRequest="36"
                         HeightRequest="36"
                         CornerRadius="18"
                         Padding="0"
                         HasShadow="False"
                         BackgroundColor="{Binding CorAvatar}"
                         VerticalOptions="Start"
                         Margin="0,4,0,0">
                    <Label Text="{Binding InicialUsuario}"
                           FontSize="16"
                           FontAttributes="Bold"
                           TextColor="White"
                           HorizontalOptions="Center"
                           VerticalOptions="Center" />
                  </Frame>

                  <!-- Card do comentÃ¡rio -->
                  <Frame Grid.Column="1"
                         Grid.Row="0"
                         Padding="12"
                         CornerRadius="8"
                         BackgroundColor="#F3F4F6"
                         HasShadow="False"
                         Margin="8,0,0,0">
                    <VerticalStackLayout Spacing="4">
                      <!-- Nome do usuÃ¡rio e badge -->
                      <HorizontalStackLayout Spacing="8">
                        <Label Text="{Binding NomeUsuario}"
                               FontSize="13"
                               FontAttributes="Bold"
                               TextColor="{DynamicResource Gray900}"
                               VerticalOptions="Center" />

                        <Frame Padding="4,2"
                               CornerRadius="4"
                               HasShadow="False"
                               BackgroundColor="{Binding CorAvatar}"
                               VerticalOptions="Center">
                          <Label Text="{Binding BadgeTipoUsuario}"
                                 FontSize="10"
                                 TextColor="White"
                                 FontAttributes="Bold" />
                        </Frame>
                      </HorizontalStackLayout>

                      <!-- Texto do comentÃ¡rio -->
                      <Label Text="{Binding Texto}"
                             FontSize="14"
                             TextColor="{DynamicResource Gray700}"
                             LineBreakMode="WordWrap"
                             Margin="0,4,0,0" />

                      <!-- Data/hora -->
                      <Label Text="{Binding TempoRelativo}"
                             FontSize="11"
                             TextColor="{DynamicResource Gray500}"
                             Margin="0,4,0,0" />

                      <!-- Indicador de comentÃ¡rio interno -->
                      <Frame Padding="6,3"
                             CornerRadius="4"
                             HasShadow="False"
                             BackgroundColor="#FEF3C7"
                             IsVisible="{Binding IsInterno}"
                             Margin="0,4,0,0">
                        <Label Text="ðŸ”’ ComentÃ¡rio Interno"
                               FontSize="11"
                               TextColor="#92400E"
                               FontAttributes="Bold" />
                      </Frame>
                    </VerticalStackLayout>
                  </Frame>
                </Grid>
              </DataTemplate>
            </CollectionView.ItemTemplate>

            <!-- EmptyView quando nÃ£o hÃ¡ comentÃ¡rios -->
            <CollectionView.EmptyView>
              <VerticalStackLayout Padding="20"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center">
                <Label Text="ðŸ’¬"
                       FontSize="36"
                       HorizontalOptions="Center" />
                <Label Text="Nenhum comentÃ¡rio ainda"
                       FontSize="13"
                       TextColor="{DynamicResource Gray600}"
                       HorizontalOptions="Center"
                       Margin="0,4,0,0" />
                <Label Text="Seja o primeiro a comentar!"
                       FontSize="12"
                       TextColor="{DynamicResource Gray500}"
                       HorizontalOptions="Center"
                       Margin="0,2,0,0" />
              </VerticalStackLayout>
            </CollectionView.EmptyView>
          </CollectionView>

          <!-- Separador -->
          <BoxView HeightRequest="1"
                   BackgroundColor="#E5E7EB"
                   Margin="0,8" />

          <!-- Campo de entrada de novo comentÃ¡rio -->
          <Grid ColumnDefinitions="*,Auto"
                ColumnSpacing="8">
            <Frame Grid.Column="0"
                   Padding="12,8"
                   CornerRadius="20"
                   BackgroundColor="#F9FAFB"
                   HasShadow="False"
                   BorderColor="#E5E7EB">
              <Entry Text="{Binding NovoComentarioTexto}"
                     Placeholder="Escreva um comentÃ¡rio..."
                     PlaceholderColor="{DynamicResource Gray400}"
                     TextColor="{DynamicResource Gray900}"
                     FontSize="14"
                     ReturnCommand="{Binding EnviarComentarioCommand}"
                     ReturnType="Send"
                     MaxLength="500"
                     VerticalOptions="Center" />
            </Frame>

            <Button Grid.Column="1"
                    Text="ðŸ“¤"
                    Command="{Binding EnviarComentarioCommand}"
                    IsEnabled="{Binding IsEnviandoComentario, Converter={StaticResource InvertedBoolConverter}}"
                    BackgroundColor="{DynamicResource Primary}"
                    TextColor="White"
                    WidthRequest="48"
                    HeightRequest="48"
                    CornerRadius="24"
                    FontSize="20"
                    Padding="0"
                    VerticalOptions="Center" />
          </Grid>

          <!-- Indicador de envio -->
          <ActivityIndicator IsRunning="{Binding IsEnviandoComentario}"
                             IsVisible="{Binding IsEnviandoComentario}"
                             Color="{DynamicResource Primary}"
                             WidthRequest="24"
                             HeightRequest="24"
                             HorizontalOptions="Center"
                             Margin="0,4,0,0" />
        </VerticalStackLayout>
      </Frame>

      <!-- Galeria de Anexos -->
      <Frame BackgroundColor="{DynamicResource White}"
             Padding="16"
             CornerRadius="12"
             HasShadow="True"
             Margin="0,16,0,0"
             IsVisible="{Binding HasAnexos}">
        <VerticalStackLayout Spacing="12">
          <!-- CabeÃ§alho -->
          <Label Text="ðŸ“Ž Anexos"
                 FontSize="16"
                 FontAttributes="Bold"
                 TextColor="{DynamicResource PrimaryDarkText}" />

          <!-- Grid de Imagens -->
          <CollectionView ItemsSource="{Binding Anexos}"
                          SelectionMode="None">
            <CollectionView.ItemsLayout>
              <GridItemsLayout Orientation="Vertical"
                               Span="2"
                               HorizontalItemSpacing="8"
                               VerticalItemSpacing="8" />
            </CollectionView.ItemsLayout>

            <CollectionView.ItemTemplate>
              <DataTemplate>
                <Frame Padding="0"
                       CornerRadius="12"
                       IsClippedToBounds="True"
                       HasShadow="False"
                       BorderColor="{DynamicResource Gray300}"
                       HeightRequest="180">
                  <Grid RowDefinitions="*,Auto">
                    <!-- Imagem -->
                    <Image Grid.Row="0"
                           Source="{Binding ImageSource}"
                           Aspect="AspectFill">
                      <Image.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:ChamadoDetailViewModel}}, Path=AbrirAnexoCommand}"
                                              CommandParameter="{Binding .}" />
                      </Image.GestureRecognizers>
                    </Image>

                    <!-- Overlay com informaÃ§Ãµes -->
                    <Grid Grid.Row="1"
                          BackgroundColor="#CC000000"
                          Padding="8">
                      <VerticalStackLayout Spacing="2">
                        <Label Text="{Binding NomeArquivo}"
                               FontSize="12"
                               TextColor="White"
                               FontAttributes="Bold"
                               LineBreakMode="TailTruncation"
                               MaxLines="1" />

                        <HorizontalStackLayout Spacing="8">
                          <Label Text="{Binding ExtensaoArquivo}"
                                 FontSize="10"
                                 TextColor="#E0E0E0" />
                          <Label Text="â€¢"
                                 FontSize="10"
                                 TextColor="#E0E0E0" />
                          <Label Text="{Binding TamanhoFormatado}"
                                 FontSize="10"
                                 TextColor="#E0E0E0" />
                        </HorizontalStackLayout>
                      </VerticalStackLayout>

                      <!-- BotÃ£o compartilhar -->
                      <Button Text="ðŸ“¤"
                              Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:ChamadoDetailViewModel}}, Path=CompartilharAnexoCommand}"
                              CommandParameter="{Binding .}"
                              BackgroundColor="{DynamicResource Primary}"
                              TextColor="White"
                              FontSize="14"
                              WidthRequest="32"
                              HeightRequest="32"
                              CornerRadius="16"
                              Padding="0"
                              HorizontalOptions="End"
                              VerticalOptions="Start"
                              Margin="0,4,4,0" />
                    </Grid>
                  </Grid>
                </Frame>
              </DataTemplate>
            </CollectionView.ItemTemplate>
          </CollectionView>

          <!-- Contador -->
          <Label Text="{Binding Anexos.Count, StringFormat='{0} arquivo(s) anexado(s)'}"
                 FontSize="12"
                 TextColor="{DynamicResource Gray600}"
                 HorizontalOptions="Center" />
        </VerticalStackLayout>
      </Frame>

      <Button Text="Encerrar chamado"
              Command="{Binding CloseChamadoCommand}"
              IsVisible="{Binding ShowCloseButton}"
              IsEnabled="{Binding IsNotBusy}"
              TextColor="{DynamicResource White}"
              BackgroundColor="{DynamicResource Primary}"
              CornerRadius="16"
              Padding="20,14"
              FontAttributes="Bold" />
    </VerticalStackLayout>
  </ScrollView>
</ContentPage>
