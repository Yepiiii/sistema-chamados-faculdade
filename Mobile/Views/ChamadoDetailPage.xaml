<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:SistemaChamados.Mobile.ViewModels"
             xmlns:converters="clr-namespace:SistemaChamados.Mobile.Converters"
             x:Class="SistemaChamados.Mobile.Views.ChamadoDetailPage"
             Title="Detalhes">
  <ContentPage.Resources>
    <ResourceDictionary>
      <!-- Conversores -->
      <converters:UtcToLocalConverter x:Key="UtcToLocalConverter" />
      <converters:IsNotNullConverter x:Key="IsNotNullConverter" />
      
      <!-- Gradientes -->
      <LinearGradientBrush x:Key="DetailHeaderGradient" StartPoint="0,0" EndPoint="1,1">
        <GradientStop Color="#2A5FDF" Offset="0" />
        <GradientStop Color="#3FA5F5" Offset="1" />
      </LinearGradientBrush>
    </ResourceDictionary>
  </ContentPage.Resources>

  <RefreshView IsRefreshing="{Binding IsRefreshing}"
               Command="{Binding RefreshCommand}"
               RefreshColor="{DynamicResource Primary}">
    <ScrollView>
      <VerticalStackLayout Padding="24" Spacing="24">
      <Border Background="{StaticResource DetailHeaderGradient}" StrokeShape="RoundRectangle 28" StrokeThickness="0" Padding="24">
        <VerticalStackLayout Spacing="6">
          <Label Text="Detalhes do chamado"
                 FontSize="22"
                 FontAttributes="Bold"
                 TextColor="{DynamicResource White}" />
          <Label Text="{Binding Chamado.Titulo}"
                 FontSize="28"
                 FontAttributes="Bold"
                 TextColor="{DynamicResource White}" />
        </VerticalStackLayout>
      </Border>

      <Frame Padding="24" CornerRadius="20" BackgroundColor="{DynamicResource White}" BorderColor="{DynamicResource Gray200}">
        <VerticalStackLayout Spacing="20">
          <!-- Badges de Status e Prioridade com indicador de encerramento -->
          <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto,Auto,Auto" ColumnSpacing="12" RowSpacing="12">
            
            <!-- Status Badge -->
            <Border Grid.Row="0" Grid.Column="0" 
                    BackgroundColor="{DynamicResource Secondary}" 
                    StrokeThickness="0" 
                    StrokeShape="RoundRectangle 12" 
                    Padding="12,6">
              <Label Text="{Binding Chamado.Status.Nome}" 
                     TextColor="{DynamicResource PrimaryDarkText}" 
                     FontAttributes="Bold" 
                     HorizontalTextAlignment="Center" />
            </Border>
            
            <!-- Prioridade Badge -->
            <Border Grid.Row="0" Grid.Column="1" 
                    Stroke="{DynamicResource Primary}" 
                    StrokeThickness="1" 
                    StrokeShape="RoundRectangle 12" 
                    Padding="12,6">
              <Label Text="{Binding Chamado.Prioridade.Nome}" 
                     TextColor="{DynamicResource Primary}" 
                     FontAttributes="Bold" 
                     HorizontalTextAlignment="Center" />
            </Border>

            <!-- Banner de Chamado Encerrado -->
            <Border Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                    IsVisible="{Binding IsChamadoEncerrado}"
                    BackgroundColor="{DynamicResource Success}"
                    StrokeThickness="0"
                    StrokeShape="RoundRectangle 12"
                    Padding="16,10">
              <HorizontalStackLayout Spacing="8" HorizontalOptions="Center">
                <Label Text="âœ“" 
                       FontSize="20" 
                       TextColor="White" 
                       FontAttributes="Bold" 
                       VerticalOptions="Center" />
                <Label Text="Chamado Encerrado" 
                       FontSize="16" 
                       FontAttributes="Bold"
                       TextColor="White" 
                       VerticalOptions="Center" />
              </HorizontalStackLayout>
            </Border>

            <!-- Data de Abertura -->
            <HorizontalStackLayout Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2" Spacing="8">
              <Label Text="ðŸ“…" FontSize="16" VerticalOptions="Center" />
              <VerticalStackLayout Spacing="2">
                <Label Text="Abertura" 
                       FontSize="12" 
                       FontAttributes="Bold"
                       TextColor="{DynamicResource Gray600}" />
                <Label Text="{Binding Chamado.DataAbertura, Converter={StaticResource UtcToLocalConverter}, StringFormat='{0:dd/MM/yyyy HH:mm}'}"
                       FontSize="14"
                       TextColor="{DynamicResource Gray700}" />
              </VerticalStackLayout>
            </HorizontalStackLayout>

            <!-- Data de Encerramento -->
            <HorizontalStackLayout Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="2" Spacing="8"
                                    IsVisible="{Binding HasFechamento}">
              <Label Text="âœ…" FontSize="16" VerticalOptions="Center" />
              <VerticalStackLayout Spacing="2">
                <Label Text="Encerramento" 
                       FontSize="12" 
                       FontAttributes="Bold"
                       TextColor="{DynamicResource Success}" />
                <Label Text="{Binding Chamado.DataFechamento, Converter={StaticResource UtcToLocalConverter}, StringFormat='{0:dd/MM/yyyy HH:mm}'}"
                       FontSize="14"
                       TextColor="{DynamicResource Gray700}" />
              </VerticalStackLayout>
            </HorizontalStackLayout>
          </Grid>

          <VerticalStackLayout Spacing="4"
                                IsVisible="{Binding Chamado.HasSolicitante}">
            <Label Text="Solicitante"
                   FontAttributes="Bold"
                   FontSize="16"
                   TextColor="{DynamicResource PrimaryDarkText}" />
            <Label Text="{Binding Chamado.SolicitanteDisplay}"
                   TextColor="{DynamicResource Gray600}" />
          </VerticalStackLayout>

          <VerticalStackLayout Spacing="8">
            <Label Text="DescriÃ§Ã£o"
                   FontAttributes="Bold"
                   FontSize="16"
                   TextColor="{DynamicResource PrimaryDarkText}" />
            <Label Text="{Binding Chamado.Descricao}"
                   TextColor="{DynamicResource Gray600}" />
          </VerticalStackLayout>
        </VerticalStackLayout>
      </Frame>

      <!-- Timeline de HistÃ³rico -->
      <Frame BackgroundColor="{DynamicResource White}"
             Padding="16"
             CornerRadius="12"
             HasShadow="True"
             Margin="0,16,0,0"
             IsVisible="{Binding Chamado.HasHistorico}">
        <VerticalStackLayout Spacing="8">
          <!-- CabeÃ§alho da seÃ§Ã£o -->
          <Label Text="ðŸ“œ HistÃ³rico de AtualizaÃ§Ãµes"
                 FontSize="16"
                 FontAttributes="Bold"
                 TextColor="{DynamicResource PrimaryDarkText}"
                 Margin="0,0,0,8" />

          <!-- CollectionView com Timeline -->
          <CollectionView ItemsSource="{Binding Chamado.Historico}"
                          SelectionMode="None">
            <CollectionView.ItemTemplate>
              <DataTemplate>
                <Grid Padding="0,0,0,16"
                      ColumnDefinitions="40,*"
                      RowDefinitions="Auto,Auto,Auto,Auto">

                  <!-- Linha vertical conectora -->
                  <BoxView Grid.Column="0"
                           Grid.Row="0"
                           Grid.RowSpan="4"
                           WidthRequest="2"
                           BackgroundColor="#E5E7EB"
                           HorizontalOptions="Center"
                           VerticalOptions="Fill"
                           Margin="0,24,0,0" />

                  <!-- Ãcone do evento (cÃ­rculo colorido com emoji) -->
                  <Frame Grid.Column="0"
                         Grid.Row="0"
                         WidthRequest="32"
                         HeightRequest="32"
                         CornerRadius="16"
                         Padding="0"
                         HasShadow="False"
                         BorderColor="{Binding CorEvento}"
                         BackgroundColor="{DynamicResource White}"
                         HorizontalOptions="Center"
                         VerticalOptions="Start">
                    <Label Text="{Binding IconeEvento}"
                           FontSize="16"
                           HorizontalOptions="Center"
                           VerticalOptions="Center" />
                  </Frame>

                  <!-- Card com conteÃºdo do evento -->
                  <Frame Grid.Column="1"
                         Grid.Row="0"
                         Padding="12"
                         CornerRadius="8"
                         BackgroundColor="#F9FAFB"
                         HasShadow="False"
                         BorderColor="#E5E7EB"
                         Margin="8,0,0,0">
                    <VerticalStackLayout Spacing="4">
                      <!-- Data e hora -->
                      <Label Text="{Binding DataHoraFormatada}"
                             FontSize="12"
                             TextColor="{DynamicResource Gray600}"
                             FontAttributes="Bold" />

                      <!-- DescriÃ§Ã£o completa (com mudanÃ§as de valor) -->
                      <Label Text="{Binding DescricaoCompleta}"
                             FontSize="14"
                             TextColor="{DynamicResource Gray700}"
                             LineBreakMode="WordWrap" />

                      <!-- UsuÃ¡rio responsÃ¡vel -->
                      <Label Text="{Binding Usuario, StringFormat='por {0}'}"
                             FontSize="12"
                             TextColor="{DynamicResource Gray600}"
                             IsVisible="{Binding Usuario, Converter={StaticResource IsNotNullConverter}}"
                             Margin="0,2,0,0" />
                    </VerticalStackLayout>
                  </Frame>
                </Grid>
              </DataTemplate>
            </CollectionView.ItemTemplate>

            <!-- EmptyView quando nÃ£o hÃ¡ histÃ³rico -->
            <CollectionView.EmptyView>
              <VerticalStackLayout Padding="20"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center">
                <Label Text="ðŸ“­"
                       FontSize="48"
                       HorizontalOptions="Center" />
                <Label Text="Nenhum histÃ³rico registrado"
                       FontSize="14"
                       TextColor="{DynamicResource Gray600}"
                       HorizontalOptions="Center"
                       Margin="0,8,0,0" />
              </VerticalStackLayout>
            </CollectionView.EmptyView>
          </CollectionView>
        </VerticalStackLayout>
      </Frame>

      <Button Text="Encerrar chamado"
              Command="{Binding CloseChamadoCommand}"
              IsVisible="{Binding ShowCloseButton}"
              IsEnabled="{Binding IsNotBusy}"
              TextColor="{DynamicResource White}"
              BackgroundColor="{DynamicResource Primary}"
              CornerRadius="16"
              Padding="20,14"
              FontAttributes="Bold" />
    </VerticalStackLayout>
  </ScrollView>
  </RefreshView>
</ContentPage>
