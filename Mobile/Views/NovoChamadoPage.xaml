<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:SistemaChamados.Mobile.ViewModels"
             x:Class="SistemaChamados.Mobile.Views.NovoChamadoPage"
             Title="Novo Chamado">
  <ContentPage.Resources>
    <Style TargetType="Label" x:Key="PageHeadlineStyle" BasedOn="{StaticResource SubHeadline}">
      <Setter Property="HorizontalOptions" Value="Start" />
      <Setter Property="HorizontalTextAlignment" Value="Start" />
      <Setter Property="FontSize" Value="28" />
      <Setter Property="FontAttributes" Value="Bold" />
      <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource PrimaryDarkText}, Dark={StaticResource White}}" />
    </Style>

    <Style TargetType="Label" x:Key="SectionTitleStyle">
      <Setter Property="FontSize" Value="18" />
      <Setter Property="FontAttributes" Value="Bold" />
      <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource PrimaryDarkText}, Dark={StaticResource White}}" />
    </Style>

    <Style TargetType="Label" x:Key="FormLabelStyle">
      <Setter Property="FontSize" Value="14" />
      <Setter Property="FontAttributes" Value="Bold" />
      <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource PrimaryDarkText}, Dark={StaticResource White}}" />
      <Setter Property="Margin" Value="0,12,0,4" />
    </Style>

    <Style TargetType="Border" x:Key="FormFieldContainerStyle">
      <Setter Property="StrokeShape" Value="RoundRectangle 16" />
      <Setter Property="StrokeThickness" Value="1" />
      <Setter Property="Stroke" Value="{AppThemeBinding Light={StaticResource Gray100Brush}, Dark={StaticResource Gray400Brush}}" />
      <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray800}}" />
      <Setter Property="Padding" Value="14,12" />
    </Style>

    <Style TargetType="Label" x:Key="EmptyStateLabelStyle">
      <Setter Property="FontSize" Value="14" />
      <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray300}}" />
      <Setter Property="HorizontalOptions" Value="Center" />
      <Setter Property="VerticalOptions" Value="Center" />
    </Style>
  </ContentPage.Resources>

  <ScrollView>
    <VerticalStackLayout Padding="24" Spacing="28">
      <VerticalStackLayout Spacing="4">
        <Label Text="Novo chamado" Style="{StaticResource PageHeadlineStyle}" />
        <Label Text="{Binding DescricaoHeader}" 
               TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray300}}" />
      </VerticalStackLayout>

      <VerticalStackLayout Spacing="24">
        <!-- DescriÃ§Ã£o do Problema (Sempre VisÃ­vel) -->
        <VerticalStackLayout Spacing="16">
          <Label Text="DescriÃ§Ã£o do problema" Style="{StaticResource SectionTitleStyle}" />

          <VerticalStackLayout>
            <Label Text="DescriÃ§Ã£o" Style="{StaticResource FormLabelStyle}" Margin="0,0,0,4" />
            <Border Style="{StaticResource FormFieldContainerStyle}">
              <Editor Placeholder="Conte o que estÃ¡ acontecendo para receber ajuda"
                      AutoSize="TextChanges"
                      MinimumHeightRequest="160"
                      Text="{Binding Descricao}"
                      PlaceholderColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray300}}" />
            </Border>
          </VerticalStackLayout>
        </VerticalStackLayout>

        <!-- BotÃ£o de OpÃ§Ãµes AvanÃ§adas (Apenas para TÃ©cnicos/Admins) -->
        <!-- BotÃ£o de OpÃ§Ãµes AvanÃ§adas (Apenas para TÃ©cnicos/Admins) -->
        <Button Text="{Binding ToggleOpcoesAvancadasTexto}"
                Command="{Binding ToggleOpcoesAvancadasCommand}"
                CornerRadius="12"
                HeightRequest="44"
                IsVisible="{Binding PodeUsarClassificacaoManual}" />

        <!-- OpÃ§Ãµes AvanÃ§adas (Apenas para TÃ©cnicos/Admins) -->
        <VerticalStackLayout Spacing="20" IsVisible="{Binding ExibirOpcoesAvancadas}">
          <Label Text="OpÃ§Ãµes avanÃ§adas" Style="{StaticResource SectionTitleStyle}" />

          <!-- TÃ­tulo (Opcional) -->
          <VerticalStackLayout>
            <Label Text="TÃ­tulo (opcional)" Style="{StaticResource FormLabelStyle}" Margin="0,0,0,4" />
            <Border Style="{StaticResource FormFieldContainerStyle}">
              <Entry Placeholder="Ex: Falha no acesso ao sistema"
                     Text="{Binding Titulo}"
                     PlaceholderColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray300}}" />
            </Border>
          </VerticalStackLayout>

          <!-- Switch de IA (Apenas para TÃ©cnicos/Admins) -->
          <VerticalStackLayout IsVisible="{Binding PodeUsarClassificacaoManual}">
            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12" Padding="0,8,0,0">
              <Label Grid.Column="0"
                     Text="Classificar automaticamente com IA"
                     Style="{StaticResource FormLabelStyle}"
                     Margin="0,0,0,0"
                     VerticalOptions="Center" />
              <Switch Grid.Column="1"
                      IsToggled="{Binding UsarAnaliseAutomatica}"
                      VerticalOptions="Center" />
            </Grid>
            <Label Text="Desative para escolher categoria e prioridade manualmente."
                   Style="{StaticResource FormLabelStyle}"
                   FontAttributes="None"
                   Margin="0,4,0,0"
                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray300}}" />
          </VerticalStackLayout>

          <!-- ClassificaÃ§Ã£o Manual (Apenas se IA desativada E TÃ©cnico/Admin) -->
          <VerticalStackLayout Spacing="16" IsVisible="{Binding ExibirClassificacaoManual}">
            <!-- Categoria -->
            <VerticalStackLayout>
              <Label Text="Categoria" Style="{StaticResource FormLabelStyle}" Margin="0,0,0,4" />
              <Border Style="{StaticResource FormFieldContainerStyle}">
                <Grid>
                  <Picker x:Name="CategoriaPicker"
                          IsVisible="{Binding HasCategorias}"
                          HorizontalOptions="Fill"
                          VerticalOptions="Center"
                          Title="Selecione uma categoria"
      TitleColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray300}}"
                          ItemsSource="{Binding Categorias}"
                          ItemDisplayBinding="{Binding Nome}"
                          SelectedItem="{Binding CategoriaSelecionada, Mode=TwoWay}"
                          SelectedIndexChanged="OnCategoriaChanged" />

                  <Label Text="Nenhuma categoria disponÃ­vel"
                         Style="{StaticResource EmptyStateLabelStyle}"
                         IsVisible="{Binding IsCategoriasEmpty}" />
                </Grid>
              </Border>
            </VerticalStackLayout>

            <!-- Prioridade -->
            <VerticalStackLayout>
              <Label Text="Prioridade" Style="{StaticResource FormLabelStyle}" Margin="0,0,0,4" />
              <Border Style="{StaticResource FormFieldContainerStyle}">
                <Grid>
                  <Picker x:Name="PrioridadePicker"
                          IsVisible="{Binding HasPrioridades}"
                          HorizontalOptions="Fill"
                          VerticalOptions="Center"
                          Title="Selecione a prioridade"
      TitleColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray300}}"
                          ItemsSource="{Binding Prioridades}"
                          ItemDisplayBinding="{Binding Nome}"
                          SelectedItem="{Binding PrioridadeSelecionada, Mode=TwoWay}"
                          SelectedIndexChanged="OnPrioridadeChanged" />

                  <Label Text="Nenhuma prioridade disponÃ­vel"
                         Style="{StaticResource EmptyStateLabelStyle}"
                         IsVisible="{Binding IsPrioridadesEmpty}" />
                </Grid>
              </Border>
            </VerticalStackLayout>
          </VerticalStackLayout>
        </VerticalStackLayout>
      </VerticalStackLayout>

      <!-- SeÃ§Ã£o de Anexos -->
      <VerticalStackLayout Spacing="12" Margin="0,8,0,0">
        <Label Text="ðŸ“Ž Anexos (Opcional)"
               FontSize="16"
               FontAttributes="Bold"
               TextColor="{DynamicResource PrimaryDarkText}" />
        
        <Label Text="Adicione imagens para ajudar a explicar o problema"
               FontSize="13"
               TextColor="{DynamicResource Gray600}"
               Margin="0,0,0,8" />

        <!-- BotÃµes de Anexar -->
        <HorizontalStackLayout Spacing="12">
          <Button Text="ðŸ“· Tirar Foto"
                  Command="{Binding TirarFotoCommand}"
                  BackgroundColor="{DynamicResource Primary}"
                  TextColor="White"
                  FontSize="14"
                  Padding="16,10"
                  CornerRadius="8"
                  HorizontalOptions="Start" />
          
          <Button Text="ðŸ–¼ï¸ Galeria"
                  Command="{Binding SelecionarImagemCommand}"
                  BackgroundColor="{DynamicResource Secondary}"
                  TextColor="White"
                  FontSize="14"
                  Padding="16,10"
                  CornerRadius="8"
                  HorizontalOptions="Start" />
        </HorizontalStackLayout>

        <!-- Lista de Anexos -->
        <CollectionView ItemsSource="{Binding AnexosTemporarios}"
                        SelectionMode="None"
                        IsVisible="{Binding HasAnexos}">
          <CollectionView.ItemsLayout>
            <LinearItemsLayout Orientation="Vertical" ItemSpacing="8" />
          </CollectionView.ItemsLayout>
          
          <CollectionView.ItemTemplate>
            <DataTemplate>
              <Frame Padding="12"
                     CornerRadius="8"
                     BackgroundColor="{DynamicResource Gray50}"
                     BorderColor="{DynamicResource Gray200}"
                     HasShadow="False">
                <Grid ColumnDefinitions="Auto,*,Auto"
                      ColumnSpacing="12">
                  
                  <!-- Thumbnail da imagem -->
                  <Frame Grid.Column="0"
                         WidthRequest="60"
                         HeightRequest="60"
                         Padding="0"
                         CornerRadius="8"
                         IsClippedToBounds="True"
                         HasShadow="False"
                         BorderColor="{DynamicResource Gray300}">
                    <Image Source="{Binding ImageSource}"
                           Aspect="AspectFill" />
                  </Frame>

                  <!-- InformaÃ§Ãµes do arquivo -->
                  <VerticalStackLayout Grid.Column="1"
                                       Spacing="4"
                                       VerticalOptions="Center">
                    <Label Text="{Binding NomeArquivo}"
                           FontSize="14"
                           FontAttributes="Bold"
                           TextColor="{DynamicResource Gray900}"
                           LineBreakMode="TailTruncation"
                           MaxLines="1" />
                    
                    <HorizontalStackLayout Spacing="8">
                      <Label Text="{Binding IconeArquivo}"
                             FontSize="12" />
                      <Label Text="{Binding ExtensaoArquivo}"
                             FontSize="12"
                             TextColor="{DynamicResource Gray600}" />
                      <Label Text="â€¢"
                             FontSize="12"
                             TextColor="{DynamicResource Gray400}" />
                      <Label Text="{Binding TamanhoFormatado}"
                             FontSize="12"
                             TextColor="{DynamicResource Gray600}" />
                    </HorizontalStackLayout>
                  </VerticalStackLayout>

                  <!-- BotÃ£o remover -->
                  <Button Grid.Column="2"
                          Text="ðŸ—‘ï¸"
                          Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:NovoChamadoViewModel}}, Path=RemoverAnexoCommand}"
                          CommandParameter="{Binding .}"
                          BackgroundColor="{DynamicResource Danger}"
                          TextColor="White"
                          FontSize="16"
                          WidthRequest="40"
                          HeightRequest="40"
                          CornerRadius="20"
                          Padding="0"
                          VerticalOptions="Center" />
                </Grid>
              </Frame>
            </DataTemplate>
          </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Contador de anexos -->
        <Label Text="{Binding AnexosTemporarios.Count, StringFormat='{0} arquivo(s) anexado(s)'}"
               FontSize="12"
               TextColor="{DynamicResource Gray500}"
               IsVisible="{Binding HasAnexos}"
               Margin="0,4,0,0" />
      </VerticalStackLayout>

      <Button Text="Criar Chamado"
              Command="{Binding CriarCommand}"
              CornerRadius="12"
              HeightRequest="52" />

      <ActivityIndicator IsRunning="{Binding IsBusy}" IsVisible="{Binding IsBusy}" />
    </VerticalStackLayout>
  </ScrollView>
</ContentPage>
