# üîß Corre√ß√µes - Novo Chamado

Data: 20 de outubro de 2025

---

## üêõ Problemas Identificados

### 1. **Crash ao criar chamado ap√≥s preencher formul√°rio**
- **Sintoma:** App crasha ao clicar em "Criar Chamado" ap√≥s preencher os dados
- **Causa:** Navega√ß√£o usando rota relativa de uma p√°gina do TabBar
- **Status:** ‚úÖ RESOLVIDO

### 2. **Funcionalidade de classifica√ß√£o manual ausente (Admin)**
- **Sintoma:** Op√ß√µes para selecionar categoria e prioridade manualmente n√£o aparecem para Admin
- **Causa:** `Settings.TipoUsuario` n√£o estava sendo salvo durante o login (valor sempre 0)
- **Status:** ‚úÖ RESOLVIDO

### 3. **Crash ao clicar em "Ver detalhes" na p√°gina de confirma√ß√£o**
- **Sintoma:** App crasha ap√≥s criar chamado e clicar em "Ver detalhes" na tela de confirma√ß√£o
- **Causa:** Navega√ß√£o usando rota relativa de uma p√°gina modal do Shell
- **Status:** ‚úÖ RESOLVIDO

---

## ‚úÖ Corre√ß√µes Aplicadas

### 1. Navega√ß√£o para P√°gina de Confirma√ß√£o

**Arquivo:** `ViewModels/NovoChamadoViewModel.cs` - M√©todo `Criar()`

**Mudan√ßa:**
```csharp
// ANTES:
await shell.GoToAsync("chamados/confirmacao", parametros);

// DEPOIS:
await shell.GoToAsync("///chamados/confirmacao", parametros);
```

**Motivo:** Como a p√°gina "Novo Chamado" √© aberta a partir de uma p√°gina do TabBar (Dashboard), ela √© considerada um elemento do Shell. A navega√ß√£o para a p√°gina de confirma√ß√£o deve usar rota **absoluta** (`///`) para funcionar corretamente.

---

### 2. Salvar TipoUsuario no Login

**Arquivo:** `Services/Auth/AuthService.cs` - M√©todo `Login()`

**Problema identificado:**
```csharp
// ANTES: S√≥ salvava o objeto completo, mas n√£o as propriedades individuais
Settings.Token = resp.Token;
Settings.SaveUser(resp.Usuario ?? new UsuarioResponseDto());
```

**Corre√ß√£o aplicada:**
```csharp
// DEPOIS: Salva tanto o objeto completo quanto as propriedades individuais
Settings.Token = resp.Token;
Settings.SaveUser(resp.Usuario ?? new UsuarioResponseDto());

// Salvar propriedades espec√≠ficas do usu√°rio para acesso r√°pido
if (resp.Usuario != null)
{
    Settings.UserId = resp.Usuario.Id;
    Settings.NomeUsuario = resp.Usuario.NomeCompleto;
    Settings.Email = resp.Usuario.Email;
    Settings.TipoUsuario = resp.Usuario.TipoUsuario;  // ‚≠ê CHAVE!
    
    App.Log($"AuthService settings saved - UserId: {Settings.UserId}, TipoUsuario: {Settings.TipoUsuario}");
}
```

**Motivo:** O `Settings.TipoUsuario` √© usado em todo o app para determinar permiss√µes:
- `TipoUsuario = 1` ‚Üí Aluno
- `TipoUsuario = 2` ‚Üí Professor/T√©cnico
- `TipoUsuario = 3` ‚Üí Administrador

Sem salvar essa propriedade, o valor sempre era **0** (zero), fazendo com que todas as verifica√ß√µes de permiss√£o falhassem:
```csharp
// Estas propriedades retornavam False quando TipoUsuario = 0
public bool IsTecnicoOuAdmin => TipoUsuarioAtual == 2 || TipoUsuarioAtual == 3;
public bool PodeUsarClassificacaoManual => IsTecnicoOuAdmin;
```

---

### 3. Logging Extensivo

**Arquivos modificados:**
- `ViewModels/NovoChamadoViewModel.cs`
- `Views/ChamadoConfirmacaoPage.xaml.cs`

**Logs adicionados:**
- ‚úÖ In√≠cio e fim do m√©todo `Criar()`
- ‚úÖ Valida√ß√µes do formul√°rio
- ‚úÖ Cria√ß√£o do DTO
- ‚úÖ Chamada ao servi√ßo
- ‚úÖ Navega√ß√£o para confirma√ß√£o
- ‚úÖ Todos os erros com stack trace
- ‚úÖ Permiss√µes do usu√°rio (TipoUsuario, IsAdmin, etc.)
- ‚úÖ Estado das op√ß√µes avan√ßadas

---

### 3. Logging Extensivo

**Arquivos modificados:**
- `ViewModels/NovoChamadoViewModel.cs`
- `Views/ChamadoConfirmacaoPage.xaml.cs`
- `Services/Auth/AuthService.cs`

**Logs adicionados:**
- ‚úÖ Tipo de usu√°rio e permiss√µes ao criar ViewModel
- ‚úÖ In√≠cio e fim do m√©todo `Criar()`
- ‚úÖ Valida√ß√µes do formul√°rio
- ‚úÖ Cria√ß√£o do DTO
- ‚úÖ Chamada ao servi√ßo
- ‚úÖ Navega√ß√£o para confirma√ß√£o
- ‚úÖ Todos os erros com stack trace
- ‚úÖ Salvamento de Settings ap√≥s login

---

### 4. Debug de Permiss√µes

**Arquivo:** `ViewModels/NovoChamadoViewModel.cs` - Construtor

**Logs adicionados:**
```csharp
App.Log($"NovoChamadoViewModel constructor - UserId: {Settings.UserId}");
App.Log($"NovoChamadoViewModel constructor - NomeUsuario: {Settings.NomeUsuario}");
App.Log($"NovoChamadoViewModel constructor - Email: {Settings.Email}");
App.Log($"NovoChamadoViewModel constructor - TipoUsuario: {Settings.TipoUsuario}");
App.Log($"NovoChamadoViewModel constructor - IsAluno: {IsAluno}, IsTecnicoOuAdmin: {IsTecnicoOuAdmin}, IsAdmin: {IsAdmin}");
App.Log($"NovoChamadoViewModel constructor - PodeUsarClassificacaoManual: {PodeUsarClassificacaoManual}");
```

**Objetivo:** Verificar se o tipo de usu√°rio est√° sendo detectado corretamente ap√≥s a corre√ß√£o.

**Valores esperados ap√≥s login como Admin:**
```
TipoUsuario: 3
IsAluno: False
IsTecnicoOuAdmin: True
IsAdmin: True
PodeUsarClassificacaoManual: True
```

---

### 5. Navega√ß√£o na P√°gina de Confirma√ß√£o

**Arquivo:** `ViewModels/ChamadoConfirmacaoViewModel.cs` - M√©todo `IrParaDetalhesAsync()`

**Problema identificado:**
```csharp
// ANTES: Usava rota relativa
await Shell.Current.GoToAsync($"chamados/detail?Id={Chamado.Id}");
```

**Corre√ß√£o aplicada:**
```csharp
// DEPOIS: Usa rota absoluta com logging extensivo
var route = $"///chamados/detail?Id={Chamado.Id}";
App.Log($"ChamadoConfirmacaoViewModel.IrParaDetalhes: navigating to {route}");
await Shell.Current.GoToAsync(route);
```

**Motivo:** A p√°gina de confirma√ß√£o √© aberta usando rota absoluta (`///chamados/confirmacao`), ent√£o ao navegar dela para os detalhes do chamado, tamb√©m precisa usar rota **absoluta** (`///chamados/detail`).

**Logging adicionado:**
- ‚úÖ In√≠cio do m√©todo
- ‚úÖ Verifica√ß√£o de Chamado nulo
- ‚úÖ Verifica√ß√£o de Shell.Current nulo
- ‚úÖ Rota de navega√ß√£o
- ‚úÖ Sucesso da navega√ß√£o
- ‚úÖ Erros com stack trace completo

---

## üß™ Como Testar

### Teste 1: Criar Chamado com IA (Qualquer usu√°rio)

1. **Login:** Use qualquer credencial
   ```
   admin@sistema.com / Admin@123
   aluno@sistema.com / Aluno@123
   ```

2. **Navega√ß√£o:**
   - Dashboard ‚Üí Bot√£o "Novo Chamado" (+)

3. **Preencher:**
   - Descri√ß√£o: "Teste de cria√ß√£o de chamado"

4. **Criar:**
   - Clicar em "Criar Chamado"
   - **Esperado:** Navegar para p√°gina de confirma√ß√£o ‚úÖ
   - **Antes:** App crashava ‚ùå

5. **Verificar logs:**
   ```powershell
   Get-Content "$env:LOCALAPPDATA\SistemaChamados.Mobile-app-log.txt" -Tail 50
   ```
   - Procurar por: `NovoChamadoViewModel.Criar`
   - Verificar se n√£o h√° erros

---

### Teste 2: Classifica√ß√£o Manual (Admin/T√©cnico apenas)

1. **Login:** Use credencial de admin
   ```
   admin@sistema.com / Admin@123
   ```

2. **Navega√ß√£o:**
   - Dashboard ‚Üí Bot√£o "Novo Chamado" (+)

3. **Verificar visibilidade:**
   - **Bot√£o "Mostrar op√ß√µes avan√ßadas"** deve estar vis√≠vel ‚úÖ
   - Se n√£o estiver, verificar logs para TipoUsuario

4. **Expandir op√ß√µes:**
   - Clicar em "Mostrar op√ß√µes avan√ßadas"
   - **Esperado:** Se√ß√£o expandida mostrando:
     - Campo "T√≠tulo (opcional)"
     - Switch "Classificar automaticamente com IA"

5. **Desligar IA:**
   - Desligar o switch de IA
   - **Esperado:** Aparecem campos:
     - Picker "Categoria"
     - Picker "Prioridade"

6. **Selecionar manualmente:**
   - Escolher uma categoria (ex: Hardware)
   - Escolher uma prioridade (ex: Alta)
   - Preencher descri√ß√£o
   - Clicar em "Criar Chamado"

7. **Verificar logs:**
   ```powershell
   Get-Content "$env:LOCALAPPDATA\SistemaChamados.Mobile-app-log.txt" -Tail 80 | Select-String "NovoChamadoViewModel"
   ```
   - Procurar por: `manual classification`
   - Verificar Cat e Prior ids

---

### Teste 3: Ver Detalhes na P√°gina de Confirma√ß√£o

1. **Login:** Use credencial de admin
   ```
   admin@sistema.com / Admin@123
   ```

2. **Criar chamado:**
   - Dashboard ‚Üí Bot√£o "Novo Chamado" (+)
   - Preencher descri√ß√£o: "Teste de confirma√ß√£o"
   - Clicar em "Criar Chamado"

3. **P√°gina de confirma√ß√£o:**
   - **Esperado:** Navegar para p√°gina de confirma√ß√£o ‚úÖ
   - **Verificar:** Protocolo do chamado aparece (ex: #25)
   - **Verificar:** Categoria, Prioridade e Status aparecem

4. **Clicar em "Ver detalhes":**
   - **Esperado:** Navegar para p√°gina de detalhes do chamado ‚úÖ
   - **Antes:** App crashava ‚ùå

5. **Verificar p√°gina de detalhes:**
   - T√≠tulo do chamado aparece
   - Descri√ß√£o aparece
   - Categoria, Prioridade e Status aparecem
   - Hist√≥rico de a√ß√µes aparece

6. **Voltar:**
   - Clicar em voltar
   - **Esperado:** Retornar ao dashboard (n√£o √† confirma√ß√£o)

7. **Verificar logs:**
   ```powershell
   Get-Content "$env:LOCALAPPDATA\SistemaChamados.Mobile-app-log.txt" -Tail 50 | Select-String "ChamadoConfirmacao"
   ```
   - Procurar por: `IrParaDetalhes`
   - Verificar se n√£o h√° erros

---

## üîç Diagn√≥stico de Problemas

### Se o app ainda crashar ao criar chamado:

1. **Ver logs completos:**
   ```powershell
   Get-Content "$env:LOCALAPPDATA\SistemaChamados.Mobile-app-log.txt" -Tail 100
   ```

2. **Procurar por:**
   - `NovoChamadoViewModel.Criar FATAL ERROR:`
   - Stack trace completo

3. **Verificar:**
   - Se a API est√° rodando (`http://localhost:5246`)
   - Se h√° erro de rede/serializa√ß√£o
   - Se o DTO est√° correto

---

### Se as op√ß√µes avan√ßadas n√£o aparecem:

1. **Verificar tipo de usu√°rio nos logs:**
   ```powershell
   Get-Content "$env:LOCALAPPDATA\SistemaChamados.Mobile-app-log.txt" | Select-String "TipoUsuario"
   ```

2. **Valores esperados:**
   - Admin: `TipoUsuario: 3`
   - T√©cnico/Professor: `TipoUsuario: 2`
   - Aluno: `TipoUsuario: 1`

3. **Propriedades esperadas (Admin/T√©cnico):**
   - `IsTecnicoOuAdmin: True`
   - `PodeUsarClassificacaoManual: True`

4. **Se TipoUsuario = 1 (Aluno):**
   - ‚úÖ Comportamento correto: op√ß√µes avan√ßadas **n√£o devem** aparecer
   - Alunos n√£o podem classificar manualmente

---

### Se os campos de categoria/prioridade n√£o aparecem:

1. **Verificar logs ao clicar em "Mostrar op√ß√µes":**
   ```powershell
   Get-Content "$env:LOCALAPPDATA\SistemaChamados.Mobile-app-log.txt" -Tail 20
   ```

2. **Procurar por:**
   - `AlternarOpcoesAvancadas - ExibirOpcoesAvancadas:`
   - `AlternarOpcoesAvancadas - UsarAnaliseAutomatica:`
   - `AlternarOpcoesAvancadas - ExibirClassificacaoManual:`

3. **Para os campos aparecerem, precisa:**
   - `ExibirOpcoesAvancadas: True` (clicou no bot√£o)
   - `UsarAnaliseAutomatica: False` (desligou o switch)
   - `IsTecnicoOuAdmin: True` (√© admin ou t√©cnico)

---

## üìä Estrutura de Visibilidade

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Descri√ß√£o (sempre vis√≠vel)              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Bot√£o "Mostrar op√ß√µes avan√ßadas"        ‚îÇ
‚îÇ IsVisible={PodeUsarClassificacaoManual} ‚îÇ
‚îÇ (Apenas Admin/T√©cnico)                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

IF ExibirOpcoesAvancadas = True:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Se√ß√£o "Op√ß√µes avan√ßadas"                ‚îÇ
‚îÇ ‚îú‚îÄ Campo "T√≠tulo" (opcional)            ‚îÇ
‚îÇ ‚îî‚îÄ Switch "Classificar com IA"          ‚îÇ
‚îÇ    (Apenas Admin/T√©cnico)                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

IF UsarAnaliseAutomatica = False:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Se√ß√£o "Classifica√ß√£o Manual"            ‚îÇ
‚îÇ ‚îú‚îÄ Picker "Categoria"                   ‚îÇ
‚îÇ ‚îî‚îÄ Picker "Prioridade"                  ‚îÇ
‚îÇ IsVisible={ExibirClassificacaoManual}   ‚îÇ
‚îÇ (Requer 3 condi√ß√µes!)                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**F√≥rmula da visibilidade:**
```csharp
ExibirClassificacaoManual = 
    ExibirOpcoesAvancadas && 
    !UsarAnaliseAutomatica && 
    IsTecnicoOuAdmin
```

---

## üéØ Checklist de Teste

### Teste B√°sico (Aluno)
- [ ] Login como aluno
- [ ] Abrir "Novo Chamado"
- [ ] **N√£o** deve ver bot√£o "Mostrar op√ß√µes avan√ßadas"
- [ ] Preencher descri√ß√£o
- [ ] Criar chamado com sucesso (IA autom√°tica)

### Teste Avan√ßado (Admin)
- [ ] Login como admin
- [ ] Abrir "Novo Chamado"
- [ ] Ver bot√£o "Mostrar op√ß√µes avan√ßadas"
- [ ] Clicar no bot√£o ‚Üí se√ß√£o expande
- [ ] Ver campo "T√≠tulo"
- [ ] Ver switch "Classificar com IA" (ligado por padr√£o)
- [ ] Desligar switch
- [ ] Ver picker "Categoria"
- [ ] Ver picker "Prioridade"
- [ ] Selecionar categoria e prioridade
- [ ] Criar chamado com classifica√ß√£o manual
- [ ] Navegar para p√°gina de confirma√ß√£o sem crash

---

### üìù Arquivos Modificados

### Com corre√ß√µes funcionais:
1. **`ViewModels/NovoChamadoViewModel.cs`**
   - Rota absoluta na navega√ß√£o para confirma√ß√£o (`///chamados/confirmacao`)
   - Logging extensivo no m√©todo Criar()
   - Logging de permiss√µes no construtor
   - Logging ao alternar op√ß√µes avan√ßadas

2. **`Services/Auth/AuthService.cs`**
   - Salvamento de `Settings.TipoUsuario` ap√≥s login
   - Salvamento de `Settings.UserId`, `Settings.NomeUsuario`, `Settings.Email`
   - Logging de confirma√ß√£o dos settings

3. **`Views/ChamadoConfirmacaoPage.xaml.cs`**
   - Logging no construtor
   - Logging no ApplyQueryAttributes

4. **`ViewModels/ChamadoConfirmacaoViewModel.cs`**
   - Rota absoluta na navega√ß√£o para detalhes (`///chamados/detail`)
   - Logging extensivo no m√©todo IrParaDetalhesAsync()
   - Try-catch com mensagem amig√°vel ao usu√°rio

### XAML (j√° estava correto):
- `Views/NovoChamadoPage.xaml`
  - Estrutura de visibilidade j√° implementada
  - Bindings corretos

---

## üöÄ Pr√≥ximos Passos

1. **Executar testes acima**
2. **Verificar logs** em `%LOCALAPPDATA%\SistemaChamados.Mobile-app-log.txt`
3. **Reportar resultados:**
   - ‚úÖ Se funcionou: documentar
   - ‚ùå Se crashou: copiar stack trace dos logs
   - ‚ö†Ô∏è Se op√ß√µes n√£o aparecem: copiar logs de permiss√µes

---

## üìö Documenta√ß√£o Relacionada

- `CORRECOES_WINDOWS.md` - Corre√ß√µes gerais do Windows
- `CORRECOES_NAVEGACAO.md` - Arquitetura de navega√ß√£o Shell
- `CREDENCIAIS_TESTE.md` - Usu√°rios para teste
- `PERMISSOES.md` - Permiss√µes por tipo de usu√°rio

---

**√öltima atualiza√ß√£o:** 20/10/2025  
**Status:** ‚úÖ Corre√ß√µes aplicadas, aguardando teste do usu√°rio
